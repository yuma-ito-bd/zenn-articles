---
title: "Google Fit APIを使って声で体重を記録・管理できるAlexaスキルを開発してみた"
emoji: "🔊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["alexa", "googlefit"]
published: false
---


## はじめに
タイトルの通りなのですが、

Alexa を使って、声だけで体重を管理、記録できるようにしたい。

スキルは非公開です。

### 実現したいこと

構成図を載せる

## Alexa スキルについて

Alexa スキルとは Alexa 向けのアプリのことです。例えば天気やニュースを教えてくれたり、音楽を流すことができます。
基本的には、

> ユーザー「アレクサ、今日の天気は？」
アレクサ「東京の天気は晴れです。」

のように Alexa に話しかけることで、Alexa が質問内容に応じて返事をしてくれます。

Alexa スキルを自分で開発することができ、Alexa Skill Kit として様々なツールが用意されています。
https://developer.amazon.com/ja-JP/alexa/alexa-skills-kit

### Alexa スキル開発の流れ

Alexa がユーザーの問いかけに対して返事をするまでの基本的な流れは以下のようになっています。
![Alexa スキルのしくみ](https://storage.googleapis.com/zenn-user-upload/3034a9cd85d9-20220305.png)
（引用：https://developer.amazon.com/ja-JP/alexa/alexa-skills-kit/start）

1. ユーザーが問いかける（例：「アレクサ、今日の天気は？」）
2. ユーザーが話した内容を対話モデル (Skill Interaction Model) を元に音声を処理して、ユーザーがどのようなリクエストを出したのかを識別する
3. 対話モデルによって識別されたリクエストをアプリケーションロジック（サーバー）に送り、アプリケーションロジックはスキルに応じた処理を行い、Alexa が答える文言を返却します。（例：天気を調べ、「東京の天気は晴れです。」という文言を生成する）
4. Alexa がユーザーに返事します。（例：「東京の天気は晴れです。」）

対話モデル（❷）とアプリケーションロジック（❸）の部分を開発することになります。
対話モデルは Alexa の[開発者コンソール](https://developer.amazon.com/alexa/console/ask)から作成することができます。アプリケーションロジックは開発者コンソール内でコーディング＆デプロイする方法のほか、AWS の Lambda など自分で用意したサーバーのアプリケーションで構築することができます。

まずはこちらのチュートリアルで簡単に Alexa スキルを開発することできます！簡単に開発できるのでぜひ試してみてください。
https://developer.amazon.com/ja/blogs/alexa/post/31c9fd71-f34f-49fc-901f-d74f4f20e28d/alexatraining-firstskill

### 「たいレコ」のモデルを構築してみる

#### スキルの新規作成
今回の「たいレコ」スキルの対話モデルを作成していきます。（チュートリアルと被る箇所は適宜省略します）

[開発者コンソール](https://developer.amazon.com/alexa/console/ask)画面の「スキル」タブから「スキルの作成」を押し、新しくスキルを作成します。

スキル名を入力し、追加する対話モデルの種類とアプリケーションロジックにあたるバックエンドリソースをホスティングする方法を選択します。

![スキルの作成](https://storage.googleapis.com/zenn-user-upload/30388c4ca3d5-20220307.png)

バックエンドリソースのホスティング方法は以下の3種類から選択できます。

- Alexa-hosted (Node.js): Alexa が用意してくれる Node.js の Lambda です。自分でリソースを用意しなくて良いので、チュートリアルとして利用したり、手軽に作成したい場合はこちらを選択すると良いと思います。
- Alexa-hosted (Python): 同じく Alexa が用意してくれる Python の Lambda です。Python で構築したい方はこちらを選択。
- ユーザー定義のプロビジョニング: 自分でリソースを用意した上で、Alexa の対話モデルからリクエストを投げる方法です。バックエンドリソースは自分好みに選択できるので、Lambda に限らず、EC2 や ECS でも可能ですし、AWS のサービスではなく Azure や GCP を利用することもできます。（Alexa スキルくらいの簡単なアプリケーションなら Lambda で十分なパターンが多いと思いますが。）

#### スキルの呼び出し名
次にスキルの呼び出し名を設定します。スキルの呼び出し名とは、スキルを呼び出す際に「Alexa、○○を開いて」と呼びかける際の○○のフレーズです。デフォルトではスキル名が設定されています。

#### 対話モデル
次に、対話モデルの構築を行います。
対話モデルは、ユーザーの声によるリクエストをアプリケーションロジック用のリクエストに変換する役割を担います。つまり、ユーザーとアプリケーションロジックを結ぶ音声インターフェースとなります。

https://developer.amazon.com/ja-JP/docs/alexa/custom-skills/create-the-interaction-model-for-your-skill.html

ここで、重要となる概念が2つあります。「インテント」と「スロット」です。

インテント (Intent) とは、ユーザーのリクエストを満たすアクションのことです。アプリケーションロジックはインテントに対応した処理を実行します。ユーザーの音声によるリクエストをインテントに変換することで、アプリケーションロジックが処理を行えるようになります。

Web アプリケーションでの MVC フレームワークの C (Controller) にあたる部分です。Android アプリにも同じような概念があるようです。

例えば、「たいレコ」では「60キロと記録して」という音声フレーズを RegisterIntent というインテントに変換するように定義できます。アプリケーションロジックでは、RegisterIntent に対応する処理（体重を記録する）を実行します。（詳しくは具体的なコードを含めて後述します。）

そして、スロットとは、ユーザーのリクエストに含まれる可変情報（日付、数量、種類など）を表したものです。スロットの設定は任意です。

例えば、「60キロと記録して」というフレーズでは「60」の部分が可変情報となります。

スロット名とスロットタイプを定義します。スロット名はインテントに含まれる変数名のことで、アプリケーションロジックではスロット名を参照することでスロットの値をすることができます。スロットタイプとは、スロットの種類のことで、数値や日付などを設定します。数値や日付などはあらかじめ標準タイプとして用意されており、またリストとして自分で定義することもできます。（[スロットタイプリファレンス \| Alexa Skills Kit](https://developer.amazon.com/ja-JP/docs/alexa/custom-skills/slot-type-reference.html#list-types)）

前置きが長くなりましたが、それでは「たいレコ」の対話モデルの設定を行いましょう。

まず、たいレコでは「体重を記録する」というアクションが必要なので、RegisterIntent というインテントを定義しましょう。

サイドバーから「カスタム＞対話モデル＞インテント」をクリックします。次に「インテントを追加」をクリックします。

「RegisterIntent」と入力し、「カスタムインテントを作成」をクリックします。

次に、「サンプル発話」にユーザーの音声リクエストのパターンを設定します。1つのインテントに対して、複数の音声パターンを割り当てることができます。（このパターンを多数用意することで、ユーザーが異なる表現をしても柔軟に応答することができ、UXの向上につながるかと思います。）

今回は以下のパターンを設定します。

- 「60キロと記録して」
- 「60キロ」（数値だけ言うパターン）

これだけでは「60キロ」しか記録することができないので、スロットを定義することで任意の体重を記録できるようにします。

「インテントスロット」にスロット名とスロットタイプを以下のように入力します。

- スロット名: `weight`
- スロットタイプ: `AMAZON.NUMBER` （数値を識別できる標準スロットタイプ）

スロットを定義したので、サンプル発話を以下のように修正します。

- `{weight}`キロと記録して
- `{weight}`キロ

そして、「モデルを保存」を押して設定を保存します。

この設定によって、ユーザーが「XXキロと記録して」または「XXキロ」とリクエストした場合、`RegisterIntent` が呼ばれ、スロット `weight` には XX という数値が入っています。

設定が完了したら「モデルをビルド」をクリックして、対話モデルをビルドしましょう。設定したフレーズによって対応するインテントが呼ばれるようになります。

モデルのビルドが完了したら、対話モデルの構築は完了です。

### アプリケーションロジックの開発

SDK



## Google Fit API について
## Alexa スキルの開発手順
## （詰まったところ）
デプロイエラー

## 学んだこと

- Alexa スキルを自分の手で開発することができた。
- OAuth 2.0 の仕組みについて理解できた。
- Terraform でインフラリソースの構成管理をする方法を知った。
